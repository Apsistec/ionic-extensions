!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@co.mmons/js-utils/core")):"function"==typeof define&&define.amd?define("@co.mmons/ionic-extensions/lazy-load",["exports","@angular/core","@co.mmons/js-utils/core"],t):t(((e=e||self).co=e.co||{},e.co.mmons=e.co.mmons||{},e.co.mmons["ionic-extensions"]=e.co.mmons["ionic-extensions"]||{},e.co.mmons["ionic-extensions"]["lazy-load"]={}),e.ng.core,e.core$1)}(this,(function(e,t,n){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */function o(e,t,n,o){var r,i=arguments.length,s=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,o);else for(var l=e.length-1;l>=0;l--)(r=e[l])&&(s=(i<3?r(s):i>3?r(t,n,s):r(t,n))||s);return i>3&&s&&Object.defineProperty(t,n,s),s}function r(e,t){return function(n,o){t(n,o,e)}}function i(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function l(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){e.done?r(e.value):new n((function(t){t(e.value)})).then(s,l)}a((o=o.apply(e,t||[])).next())}))}function s(e,t){var n,o,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function l(i){return function(l){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,o=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){s.label=i[1];break}if(6===i[0]&&s.label<r[1]){s.label=r[1],r=i;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(i);break}r[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,l])}}}function l(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}}var a={selector:"img",container:window,scroll:null,threshold:300,throttle:150,dataSrc:"original",dataSrcSet:"original-set",dataAlternate:"alternate",classLoading:"ionx-lazy-image-loading",classLoaded:"ionx-lazy-image-loaded",skipInvisible:!0,callbackLoad:null,callbackError:null,callbackSet:null,callbackProcessed:null};function c(e,t,n){var o,r,i;function s(){return window.innerWidth||o.documentElement.clientWidth||document.body.clientWidth}function l(e){return e.getBoundingClientRect().top+r-o.documentElement.clientTop}function a(e){return e.getBoundingClientRect().left+i-o.documentElement.clientLeft}return o=e.ownerDocument,r=window.pageYOffset||o.body.scrollTop,i=window.pageXOffset||o.body.scrollLeft,!((t===window?(window.innerHeight||o.documentElement.clientHeight||document.body.clientHeight)+r:l(t)+t.offsetHeight)<=l(e)-n||(t===window?r:l(t))>=l(e)+n+e.offsetHeight||(t===window?s()+window.pageXOffset:a(t)+s())<=a(e)-n||(t===window?i:a(t))>=a(e)+n+e.offsetWidth)}function d(){return(new Date).getTime()}function u(e,t){return function(){return e.apply(t,arguments)}}var h=0,p={},f=function(){function e(e){this.id=++h+"",p[this.id]=this,this._options=Object.assign({},a,e),this._queryOriginNode=this._options.container===window?document:this._options.container,this._previousLoopTime=0,this._loopTimeout=null,this._handleScrollFn=u(this.handleScroll,this),window.addEventListener("resize",this._handleScrollFn),this.update()}return Object.defineProperty(e.prototype,"container",{get:function(){return this._queryOriginNode},enumerable:!0,configurable:!0}),e.prototype._showOnAppear=function(e){var t=this,n=function(){var r=e;e.__ionxLazyLoadTmpImg&&(r=e.__ionxLazyLoadTmpImg);var i=t._options&&t._options.dataAlternate&&e.getAttribute("data-"+t._options.dataAlternate);i&&r.src!=i?r.src=i:(delete e.__ionxLazyLoadTmpImg,r.removeEventListener("load",o),r.removeEventListener("error",n),e.lazyLoadError=!0,t._options&&(e.classList.remove(t._options.classLoading),t._options.callbackError&&t._options.callbackError.callback_error(e)))},o=function(){if(null!==t._options&&void 0!==t._options){var r=e;e.__ionxLazyLoadTmpImg&&(r=e.__ionxLazyLoadTmpImg,e.style.backgroundImage="url("+r.src+")",delete e.__ionxLazyLoadTmpImg),e.lazyLoadError=!1,t._options&&(t._options.callbackLoad&&t._options.callbackLoad(e),e.classList.remove(t._options.classLoading),e.classList.add(t._options.classLoaded)),r.removeEventListener("load",o),r.removeEventListener("error",n)}};if(this._options&&e.classList.add(this._options.classLoading),"IMG"===e.tagName.toUpperCase()||"IFRAME"===e.tagName.toUpperCase())e.addEventListener("load",o),e.addEventListener("error",n);else if("VIDEO"===e.tagName.toUpperCase())e.addEventListener("loadedmetadata",o),e.addEventListener("error",n);else{var r=new Image;r.addEventListener("load",o),r.addEventListener("error",n),e.__ionxLazyLoadTmpImg=r}this._options&&(!function(e,t,n){var o=e.tagName.toUpperCase(),r=e.getAttribute("data-"+n);if("IFRAME"!==o&&"VIDEO"!==o){"IMG"===o&&function(e,t){var n=e.parentElement;if("PICTURE"===n.tagName)for(var o=0;o<n.children.length;o++){var r=n.children[o];if("SOURCE"===r.tagName){var i=r.getAttribute("data-"+t);i&&r.setAttribute("srcset",i)}}}(e,t);var i=e;e.__ionxLazyLoadTmpImg&&(i=e.__ionxLazyLoadTmpImg);var s=e.getAttribute("data-"+t);return s&&i.setAttribute("srcset",s),void(r&&i.setAttribute("src",r))}r&&e.setAttribute("src",r)}(e,this._options.dataSrcSet,this._options.dataSrc),this._options.callbackSet&&this._options.callbackSet(e))},e.prototype._loopThroughElements=function(){for(var e=this._elements?this._elements.length:0,t=[],n=0;n<e;n++){var o=this._elements[n];(!1===this._options.skipInvisible||null!==o.offsetParent&&0!==o.offsetHeight&&0!==o.offsetWidth)&&(c(o,this._options.container,this._options.threshold)&&(this._showOnAppear(o),t.push(n),o.lazyLoadProcessed=!0))}for(;t.length>0;)this._elements.splice(t.pop(),1),this._options.callbackProcessed&&this._options.callbackProcessed(this._elements.length);0===e&&this._stopScrollHandler()},e.prototype._purgeElements=function(){for(var e=[],t=0;t<this._elements.length;t++){this._elements[t].lazyLoadProcessed&&e.push(t)}for(;e.length>0;)this._elements.splice(e.pop(),1)},e.prototype._startScrollHandler=function(){this._isHandlingScroll||(this._isHandlingScroll=!0,this._options.container.addEventListener("scroll",this._handleScrollFn),this._options.scroll&&this._options.scroll.addEventListener("scroll",this._handleScrollFn))},e.prototype._stopScrollHandler=function(){this._isHandlingScroll&&(this._isHandlingScroll=!1,this._options.container.removeEventListener("scroll",this._handleScrollFn),this._options.scroll&&this._options.scroll.removeEventListener("scroll",this._handleScrollFn))},e.prototype.handleScroll=function(){var e,t,n;this._options&&(t=d(),0!==(n=this._options.throttle)?(e=n-(t-this._previousLoopTime))<=0||e>n?(this._loopTimeout&&(clearTimeout(this._loopTimeout),this._loopTimeout=null),this._previousLoopTime=t,this._loopThroughElements()):this._loopTimeout||(this._loopTimeout=setTimeout(u((function(){this._previousLoopTime=d(),this._loopTimeout=null,this._loopThroughElements()}),this),e)):this._loopThroughElements())},e.prototype.update=function(e){var t,n,o;if(this._elements=(o=this._queryOriginNode.querySelectorAll(this._options.selector),Array.prototype.slice.call(o)),e&&e.retryError)try{for(var r=l(this._elements),i=r.next();!i.done;i=r.next()){var s=i.value;s.lazyLoadProcessed&&s.lazyLoadError&&(s.lazyLoadProcessed=!1)}}catch(e){t={error:e}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}this._purgeElements(),this._loopThroughElements(),this._startScrollHandler()},e.prototype.destroy=function(){window.removeEventListener("resize",this._handleScrollFn),this._loopTimeout&&(clearTimeout(this._loopTimeout),this._loopTimeout=null),this._stopScrollHandler(),this._elements=null,this._queryOriginNode=null,this._options=null,delete p[this.id]},e}();var m=function(){function e(e){this.element=e}return e.prototype.revalidate=function(){if(this.loader){this.loader.update();var e=this.element.nativeElement.getBoundingClientRect();0==e.width||e.height}},e.prototype.ngOnInit=function(){this.init()},e.prototype.ngAfterContentInit=function(){var e=this;this.children.changes.subscribe((function(){return e.revalidate()})),this.children.length>0&&this.revalidate()},e.prototype.ngOnDestroy=function(){this.loader&&this.loader.destroy()},e.prototype.init=function(){return i(this,void 0,void 0,(function(){var e,t;return s(this,(function(o){switch(o.label){case 0:if((e={}).selector=".ionx-lazy-load",e.container=this.element.nativeElement,"ion-content"!==this.element.nativeElement.tagName.toLowerCase())return[3,5];t=0,o.label=1;case 1:return t<40?(e.scroll=this.element.nativeElement.shadowRoot&&this.element.nativeElement.shadowRoot.querySelector(".inner-scroll"),e.scroll?[3,3]:[4,n.sleep(50)]):[3,5];case 2:return o.sent(),[3,4];case 3:return[3,5];case 4:return t++,[3,1];case 5:return this.loader=new f(e),[2]}}))}))},e.ctorParameters=function(){return[{type:t.ElementRef}]},o([t.ContentChildren(t.forwardRef((function(){return _})),{descendants:!0})],e.prototype,"children",void 0),e=o([t.Directive({selector:"[ionx-lazy-load-container]"})],e)}(),_=function(){function e(e,t,n){this.element=e,this.renderer=t,this.container=n}var n;return n=e,Object.defineProperty(e.prototype,"src",{set:function(e){this._src=e,this.reset()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"alternate",{set:function(e){this._alternate=e,this.reset()},enumerable:!0,configurable:!0}),e.prototype.reset=function(){this._src&&(this.renderer.addClass(this.element.nativeElement,"ionx-lazy-load"),this.renderer.setAttribute(this.element.nativeElement,"data-original",this._src)),this._alternate&&this.renderer.setAttribute(this.element.nativeElement,"data-alternate",this._alternate)},e.prototype.revalidate=function(){this.container&&this.children.length>1&&this.container.revalidate()},e.prototype.ngAfterContentInit=function(){var e=this;this.children.changes.subscribe((function(){return e.revalidate()})),this.revalidate()},e.ctorParameters=function(){return[{type:t.ElementRef},{type:t.Renderer2},{type:m,decorators:[{type:t.Optional},{type:t.Inject,args:[t.forwardRef((function(){return m}))]}]}]},o([t.ContentChildren(n,{descendants:!0})],e.prototype,"children",void 0),o([t.Input("ionx-lazy-load")],e.prototype,"src",null),o([t.Input("ionx-lazy-load-alternate")],e.prototype,"alternate",null),e=n=o([t.Directive({selector:"[ionx-lazy-load]"}),r(2,t.Optional()),r(2,t.Inject(t.forwardRef((function(){return m}))))],e)}(),y=function(){function e(){}return e=o([t.NgModule({declarations:[_,m],exports:[_,m]})],e)}();e.LazyDirectives=_,e.LazyLoadContainer=m,e.LazyLoadModule=y,e.ensureLazyLoad=function(e,t){return i(this,void 0,void 0,(function(){var n,o,r,i;return s(this,(function(s){for(n in p)if(o=p[n],r=o.container,e===r)o.update({retryError:t&&t.retryError});else{for(i=r.parentElement;i&&i!==e;)i=i.parentElement;i&&o.update({retryError:t&&t.retryError})}return[2]}))}))},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=lazy-load-module.umd.min.js.map