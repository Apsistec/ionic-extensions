import { __awaiter, __decorate, __generator } from "tslib";
import { Component } from "@angular/core";
import { EventManager } from "@angular/platform-browser";
import { unsubscribe } from "@co.mmons/rxjs-utils";
import { ModalController, Platform, PopoverController } from "@ionic/angular";
import { redo, redoDepth, undo, undoDepth } from "prosemirror-history";
import { findParentNode, findParentNodeOfType } from "prosemirror-utils";
import { AlignmentMenu } from "./alignment-menu";
import { HtmlEditor } from "./editor";
import { HeadingMenu } from "./heading-menu";
import { InsertMenu } from "./insert-menu";
import { LinkModal } from "./link-modal";
import { ListMenu } from "./list-menu";
import { anyMarkActive, isMarkActive } from "./prosemirror/is-active";
import { schema } from "./prosemirror/schema";
import { isBlockMarkActive } from "./prosemirror/utils/selection/is-block-mark-active";
import { TextFormatMenu } from "./text-format-menu";
var Toolbar = /** @class */ (function () {
    function Toolbar(popoverController, platform, editor, eventManager, modalController) {
        this.popoverController = popoverController;
        this.platform = platform;
        this.editor = editor;
        this.eventManager = eventManager;
        this.modalController = modalController;
        this.activeFeatures = {};
    }
    Toolbar.prototype.showMenu = function (event, menu) {
        return __awaiter(this, void 0, void 0, function () {
            var components, popover;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        components = {
                            text: TextFormatMenu,
                            list: ListMenu,
                            alignment: AlignmentMenu,
                            insert: InsertMenu,
                            heading: HeadingMenu
                        };
                        return [4 /*yield*/, this.popoverController.create({
                                component: components[menu],
                                componentProps: {
                                    editor: this.editor
                                },
                                event: event,
                                showBackdrop: this.platform.is("ios")
                            })];
                    case 1:
                        popover = _a.sent();
                        popover.present();
                        return [2 /*return*/];
                }
            });
        });
    };
    Toolbar.prototype.editLink = function () {
        return __awaiter(this, void 0, void 0, function () {
            return __generator(this, function (_a) {
                LinkModal.present(this.modalController, this.editor);
                return [2 /*return*/];
            });
        });
    };
    Toolbar.prototype.undo = function () {
        var _this = this;
        undo(this.editor.view.state, function (transaction) { return _this.editor.view.updateState(_this.editor.view.state.apply(transaction)); });
        this.editor.focus();
    };
    Toolbar.prototype.redo = function () {
        var _this = this;
        redo(this.editor.view.state, function (transaction) { return _this.editor.view.updateState(_this.editor.view.state.apply(transaction)); });
        this.editor.focus();
    };
    Toolbar.prototype.editorSelectionChanged = function () {
        this.canUndo = undoDepth(this.editor.view.state) > 0;
        this.canRedo = redoDepth(this.editor.view.state) > 0;
        this.activeFeatures = {};
        this.activeFeatures.text = anyMarkActive(this.editor.view.state, [schema.marks.strong, schema.marks.em, schema.marks.underline, schema.marks.fontSize]);
        this.activeFeatures.list = !!findParentNode(function (predicate) { return predicate.hasMarkup(schema.nodes.orderedList) || predicate.hasMarkup(schema.nodes.bulletList); })(this.editor.state.selection);
        this.activeFeatures.alignment = isBlockMarkActive(this.editor.view.state, schema.marks.alignment);
        this.activeFeatures.heading = !!findParentNodeOfType(schema.nodes.heading)(this.editor.state.selection);
        this.activeFeatures.link = isMarkActive(this.editor.view.state, schema.marks.link);
    };
    Toolbar.prototype.ngOnInit = function () {
        return __awaiter(this, void 0, void 0, function () {
            var _this = this;
            return __generator(this, function (_a) {
                this.selectionSubscription = this.editor.selectionChange.subscribe(function () { return _this.editorSelectionChanged(); });
                this.editorSelectionChanged();
                return [2 /*return*/];
            });
        });
    };
    Toolbar.prototype.ngOnDestroy = function () {
        unsubscribe(this.selectionSubscription);
    };
    Toolbar.ctorParameters = function () { return [
        { type: PopoverController },
        { type: Platform },
        { type: HtmlEditor },
        { type: EventManager },
        { type: ModalController }
    ]; };
    Toolbar = __decorate([
        Component({
            selector: "ionx-html-editor-toolbar",
            template: "\n        <ion-button size=\"small\" fill=\"clear\" [class.active-feature]=\"activeFeatures.text\" (click)=\"showMenu($event, 'text')\">\n            <ion-icon name=\"dropdown\" slot=\"end\"></ion-icon>\n            <span>{{\"@co.mmons/ionic-extensions/html-editor#Text\" | intlMessage}}</span>\n        </ion-button>\n\n        <ion-button size=\"small\" fill=\"clear\" [class.active-feature]=\"activeFeatures.alignment\" (click)=\"showMenu($event, 'alignment')\" *ngIf=\"!editor.features || editor.features.alignment\">\n            <ion-icon name=\"dropdown\" slot=\"end\"></ion-icon>\n            <span>{{\"@co.mmons/ionic-extensions/html-editor#Alignment\" | intlMessage}}</span>\n        </ion-button>\n\n        <ion-button size=\"small\" fill=\"clear\" [class.active-feature]=\"activeFeatures.heading\" (click)=\"showMenu($event, 'heading')\" *ngIf=\"!editor.features || editor.features.heading\">\n            <ion-icon name=\"dropdown\" slot=\"end\"></ion-icon>\n            <span>{{\"@co.mmons/ionic-extensions/html-editor#Heading\" | intlMessage}}</span>\n        </ion-button>\n        \n        <ion-button size=\"small\" fill=\"clear\" [class.active-feature]=\"activeFeatures.list\" (click)=\"showMenu($event, 'list')\" *ngIf=\"!editor.features || editor.features.list\">\n            <ion-icon name=\"dropdown\" slot=\"end\"></ion-icon>\n            <span>{{\"@co.mmons/ionic-extensions/html-editor#listMenu/List\" | intlMessage}}</span>\n        </ion-button>\n\n        <ion-button size=\"small\" fill=\"clear\" (click)=\"showMenu($event, 'insert')\" *ngIf=\"!editor.features || editor.features.link || editor.features.multimedia\">\n            <ion-icon name=\"dropdown\" slot=\"end\"></ion-icon>\n            <span>{{\"@co.mmons/ionic-extensions/html-editor#Insert\" | intlMessage}}</span>\n        </ion-button>\n        \n        <ion-button size=\"small\" fill=\"clear\" class=\"active-feature\" (click)=\"editLink()\" *ngIf=\"activeFeatures.link\">\n            <span>{{\"@co.mmons/ionic-extensions/html-editor#link/Link\" | intlMessage}}</span>\n        </ion-button>\n        \n        <div ionx--buttons-group>\n            <ion-button size=\"small\" fill=\"clear\" tabindex=\"-1\" title=\"{{'@co.mmons/ionic-extensions/html-editor#Undo' | intlMessage}}\" [disabled]=\"!canUndo\" (click)=\"undo()\">\n                <ion-icon name=\"assets/html-editor/undo.svg\" slot=\"icon-only\"></ion-icon>\n            </ion-button>\n    \n            <ion-button size=\"small\" fill=\"clear\" title=\"{{'@co.mmons/ionic-extensions/html-editor#Redo' | intlMessage}}\" [disabled]=\"!canRedo\" (click)=\"redo()\">\n                <ion-icon name=\"assets/html-editor/redo.svg\" slot=\"icon-only\"></ion-icon>\n            </ion-button>\n        </div>\n    ",
            styles: ["\n        :host { outline: none; display: flex; justify-content: center; flex-wrap: wrap; position: sticky; position: -webkit-sticky; top: 0px; background-color: var(--background); z-index: 1; }\n        :host-context(.ion-focused) { background-color: var(--background-focused); }\n        :host ion-button { margin: 0px 4px; --padding-end: 2px; --padding-start: 4px; }\n        :host ion-button.active-feature span { font-weight: 800; }\n        :host ion-icon[slot=\"end\"] { margin: 0px; }\n        :host ion-button[disabled] { opacity: 0.5; }\n        :host [ionx--buttons-group] { display: flex; }\n        :host [ionx--buttons-group] ion-button:not(:last-child) { margin-right: 0px; }\n    "]
        })
    ], Toolbar);
    return Toolbar;
}());
export { Toolbar };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9vbGJhci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bjby5tbW9ucy9pb25pYy1leHRlbnNpb25zL2h0bWwtZWRpdG9yLyIsInNvdXJjZXMiOlsidG9vbGJhci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFDLFNBQVMsRUFBb0IsTUFBTSxlQUFlLENBQUM7QUFDM0QsT0FBTyxFQUFDLFlBQVksRUFBQyxNQUFNLDJCQUEyQixDQUFDO0FBQ3ZELE9BQU8sRUFBQyxXQUFXLEVBQUMsTUFBTSxzQkFBc0IsQ0FBQztBQUNqRCxPQUFPLEVBQUMsZUFBZSxFQUFFLFFBQVEsRUFBRSxpQkFBaUIsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQzVFLE9BQU8sRUFBQyxJQUFJLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUMsTUFBTSxxQkFBcUIsQ0FBQztBQUNyRSxPQUFPLEVBQUMsY0FBYyxFQUFFLG9CQUFvQixFQUFDLE1BQU0sbUJBQW1CLENBQUM7QUFFdkUsT0FBTyxFQUFDLGFBQWEsRUFBQyxNQUFNLGtCQUFrQixDQUFDO0FBQy9DLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxVQUFVLENBQUM7QUFDcEMsT0FBTyxFQUFDLFdBQVcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDekMsT0FBTyxFQUFDLFNBQVMsRUFBQyxNQUFNLGNBQWMsQ0FBQztBQUN2QyxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0sYUFBYSxDQUFDO0FBQ3JDLE9BQU8sRUFBQyxhQUFhLEVBQUUsWUFBWSxFQUFDLE1BQU0seUJBQXlCLENBQUM7QUFDcEUsT0FBTyxFQUFDLE1BQU0sRUFBQyxNQUFNLHNCQUFzQixDQUFDO0FBQzVDLE9BQU8sRUFBQyxpQkFBaUIsRUFBQyxNQUFNLG9EQUFvRCxDQUFDO0FBQ3JGLE9BQU8sRUFBQyxjQUFjLEVBQUMsTUFBTSxvQkFBb0IsQ0FBQztBQXVE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QUFxQixDQUFDLENBQUM7SUFDNUMsQ0FBQzs7Z0JBbkY4QixpQkFBaUI7Z0JBQzFCLFFBQVE7Z0JBQ0YsVUFBVTtnQkFDVixZQUFZO2dCQUNYLGVBQWU7O0lBUG5DLE9BQU87UUFyRG5CLFNBQVMsQ0FBQztZQUNQLFFBQVEsRUFBRSwwQkFBMEI7WUFDcEMsUUFBUSxFQUFFLHN0RkF1Q1Q7cUJBQ1EsMHJCQVNSO1NBQ0osQ0FBQztPQUNXLE9BQU8sQ0F3Rm5CO0lBQUQsY0FBQztDQUFBLEFBeEZELElBd0ZDO1NBeEZZLE9BQU8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NvbXBvbmVudCwgT25EZXN0cm95LCBPbkluaXR9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQge0V2ZW50TWFuYWdlcn0gZnJvbSBcIkBhbmd1bGFyL3BsYXRmb3JtLWJyb3dzZXJcIjtcbmltcG9ydCB7dW5zdWJzY3JpYmV9IGZyb20gXCJAY28ubW1vbnMvcnhqcy11dGlsc1wiO1xuaW1wb3J0IHtNb2RhbENvbnRyb2xsZXIsIFBsYXRmb3JtLCBQb3BvdmVyQ29udHJvbGxlcn0gZnJvbSBcIkBpb25pYy9hbmd1bGFyXCI7XG5pbXBvcnQge3JlZG8sIHJlZG9EZXB0aCwgdW5kbywgdW5kb0RlcHRofSBmcm9tIFwicHJvc2VtaXJyb3ItaGlzdG9yeVwiO1xuaW1wb3J0IHtmaW5kUGFyZW50Tm9kZSwgZmluZFBhcmVudE5vZGVPZlR5cGV9IGZyb20gXCJwcm9zZW1pcnJvci11dGlsc1wiO1xuaW1wb3J0IHtTdWJzY3JpcHRpb259IGZyb20gXCJyeGpzXCI7XG5pbXBvcnQge0FsaWdubWVudE1lbnV9IGZyb20gXCIuL2FsaWdubWVudC1tZW51XCI7XG5pbXBvcnQge0h0bWxFZGl0b3J9IGZyb20gXCIuL2VkaXRvclwiO1xuaW1wb3J0IHtIZWFkaW5nTWVudX0gZnJvbSBcIi4vaGVhZGluZy1tZW51XCI7XG5pbXBvcnQge0luc2VydE1lbnV9IGZyb20gXCIuL2luc2VydC1tZW51XCI7XG5pbXBvcnQge0xpbmtNb2RhbH0gZnJvbSBcIi4vbGluay1tb2RhbFwiO1xuaW1wb3J0IHtMaXN0TWVudX0gZnJvbSBcIi4vbGlzdC1tZW51XCI7XG5pbXBvcnQge2FueU1hcmtBY3RpdmUsIGlzTWFya0FjdGl2ZX0gZnJvbSBcIi4vcHJvc2VtaXJyb3IvaXMtYWN0aXZlXCI7XG5pbXBvcnQge3NjaGVtYX0gZnJvbSBcIi4vcHJvc2VtaXJyb3Ivc2NoZW1hXCI7XG5pbXBvcnQge2lzQmxvY2tNYXJrQWN0aXZlfSBmcm9tIFwiLi9wcm9zZW1pcnJvci91dGlscy9zZWxlY3Rpb24vaXMtYmxvY2stbWFyay1hY3RpdmVcIjtcbmltcG9ydCB7VGV4dEZvcm1hdE1lbnV9IGZyb20gXCIuL3RleHQtZm9ybWF0LW1lbnVcIjtcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6IFwiaW9ueC1odG1sLWVkaXRvci10b29sYmFyXCIsXG4gICAgdGVtcGxhdGU6IGBcbiAgICAgICAgPGlvbi1idXR0b24gc2l6ZT1cInNtYWxsXCIgZmlsbD1cImNsZWFyXCIgW2NsYXNzLmFjdGl2ZS1mZWF0dXJlXT1cImFjdGl2ZUZlYXR1cmVzLnRleHRcIiAoY2xpY2spPVwic2hvd01lbnUoJGV2ZW50LCAndGV4dCcpXCI+XG4gICAgICAgICAgICA8aW9uLWljb24gbmFtZT1cImRyb3Bkb3duXCIgc2xvdD1cImVuZFwiPjwvaW9uLWljb24+XG4gICAgICAgICAgICA8c3Bhbj57e1wiQGNvLm1tb25zL2lvbmljLWV4dGVuc2lvbnMvaHRtbC1lZGl0b3IjVGV4dFwiIHwgaW50bE1lc3NhZ2V9fTwvc3Bhbj5cbiAgICAgICAgPC9pb24tYnV0dG9uPlxuXG4gICAgICAgIDxpb24tYnV0dG9uIHNpemU9XCJzbWFsbFwiIGZpbGw9XCJjbGVhclwiIFtjbGFzcy5hY3RpdmUtZmVhdHVyZV09XCJhY3RpdmVGZWF0dXJlcy5hbGlnbm1lbnRcIiAoY2xpY2spPVwic2hvd01lbnUoJGV2ZW50LCAnYWxpZ25tZW50JylcIiAqbmdJZj1cIiFlZGl0b3IuZmVhdHVyZXMgfHwgZWRpdG9yLmZlYXR1cmVzLmFsaWdubWVudFwiPlxuICAgICAgICAgICAgPGlvbi1pY29uIG5hbWU9XCJkcm9wZG93blwiIHNsb3Q9XCJlbmRcIj48L2lvbi1pY29uPlxuICAgICAgICAgICAgPHNwYW4+e3tcIkBjby5tbW9ucy9pb25pYy1leHRlbnNpb25zL2h0bWwtZWRpdG9yI0FsaWdubWVudFwiIHwgaW50bE1lc3NhZ2V9fTwvc3Bhbj5cbiAgICAgICAgPC9pb24tYnV0dG9uPlxuXG4gICAgICAgIDxpb24tYnV0dG9uIHNpemU9XCJzbWFsbFwiIGZpbGw9XCJjbGVhclwiIFtjbGFzcy5hY3RpdmUtZmVhdHVyZV09XCJhY3RpdmVGZWF0dXJlcy5oZWFkaW5nXCIgKGNsaWNrKT1cInNob3dNZW51KCRldmVudCwgJ2hlYWRpbmcnKVwiICpuZ0lmPVwiIWVkaXRvci5mZWF0dXJlcyB8fCBlZGl0b3IuZmVhdHVyZXMuaGVhZGluZ1wiPlxuICAgICAgICAgICAgPGlvbi1pY29uIG5hbWU9XCJkcm9wZG93blwiIHNsb3Q9XCJlbmRcIj48L2lvbi1pY29uPlxuICAgICAgICAgICAgPHNwYW4+e3tcIkBjby5tbW9ucy9pb25pYy1leHRlbnNpb25zL2h0bWwtZWRpdG9yI0hlYWRpbmdcIiB8IGludGxNZXNzYWdlfX08L3NwYW4+XG4gICAgICAgIDwvaW9uLWJ1dHRvbj5cbiAgICAgICAgXG4gICAgICAgIDxpb24tYnV0dG9uIHNpemU9XCJzbWFsbFwiIGZpbGw9XCJjbGVhclwiIFtjbGFzcy5hY3RpdmUtZmVhdHVyZV09XCJhY3RpdmVGZWF0dXJlcy5saXN0XCIgKGNsaWNrKT1cInNob3dNZW51KCRldmVudCwgJ2xpc3QnKVwiICpuZ0lmPVwiIWVkaXRvci5mZWF0dXJlcyB8fCBlZGl0b3IuZmVhdHVyZXMubGlzdFwiPlxuICAgICAgICAgICAgPGlvbi1pY29uIG5hbWU9XCJkcm9wZG93blwiIHNsb3Q9XCJlbmRcIj48L2lvbi1pY29uPlxuICAgICAgICAgICAgPHNwYW4+e3tcIkBjby5tbW9ucy9pb25pYy1leHRlbnNpb25zL2h0bWwtZWRpdG9yI2xpc3RNZW51L0xpc3RcIiB8IGludGxNZXNzYWdlfX08L3NwYW4+XG4gICAgICAgIDwvaW9uLWJ1dHRvbj5cblxuICAgICAgICA8aW9uLWJ1dHRvbiBzaXplPVwic21hbGxcIiBmaWxsPVwiY2xlYXJcIiAoY2xpY2spPVwic2hvd01lbnUoJGV2ZW50LCAnaW5zZXJ0JylcIiAqbmdJZj1cIiFlZGl0b3IuZmVhdHVyZXMgfHwgZWRpdG9yLmZlYXR1cmVzLmxpbmsgfHwgZWRpdG9yLmZlYXR1cmVzLm11bHRpbWVkaWFcIj5cbiAgICAgICAgICAgIDxpb24taWNvbiBuYW1lPVwiZHJvcGRvd25cIiBzbG90PVwiZW5kXCI+PC9pb24taWNvbj5cbiAgICAgICAgICAgIDxzcGFuPnt7XCJAY28ubW1vbnMvaW9uaWMtZXh0ZW5zaW9ucy9odG1sLWVkaXRvciNJbnNlcnRcIiB8IGludGxNZXNzYWdlfX08L3NwYW4+XG4gICAgICAgIDwvaW9uLWJ1dHRvbj5cbiAgICAgICAgXG4gICAgICAgIDxpb24tYnV0dG9uIHNpemU9XCJzbWFsbFwiIGZpbGw9XCJjbGVhclwiIGNsYXNzPVwiYWN0aXZlLWZlYXR1cmVcIiAoY2xpY2spPVwiZWRpdExpbmsoKVwiICpuZ0lmPVwiYWN0aXZlRmVhdHVyZXMubGlua1wiPlxuICAgICAgICAgICAgPHNwYW4+e3tcIkBjby5tbW9ucy9pb25pYy1leHRlbnNpb25zL2h0bWwtZWRpdG9yI2xpbmsvTGlua1wiIHwgaW50bE1lc3NhZ2V9fTwvc3Bhbj5cbiAgICAgICAgPC9pb24tYnV0dG9uPlxuICAgICAgICBcbiAgICAgICAgPGRpdiBpb254LS1idXR0b25zLWdyb3VwPlxuICAgICAgICAgICAgPGlvbi1idXR0b24gc2l6ZT1cInNtYWxsXCIgZmlsbD1cImNsZWFyXCIgdGFiaW5kZXg9XCItMVwiIHRpdGxlPVwie3snQGNvLm1tb25zL2lvbmljLWV4dGVuc2lvbnMvaHRtbC1lZGl0b3IjVW5kbycgfCBpbnRsTWVzc2FnZX19XCIgW2Rpc2FibGVkXT1cIiFjYW5VbmRvXCIgKGNsaWNrKT1cInVuZG8oKVwiPlxuICAgICAgICAgICAgICAgIDxpb24taWNvbiBuYW1lPVwiYXNzZXRzL2h0bWwtZWRpdG9yL3VuZG8uc3ZnXCIgc2xvdD1cImljb24tb25seVwiPjwvaW9uLWljb24+XG4gICAgICAgICAgICA8L2lvbi1idXR0b24+XG4gICAgXG4gICAgICAgICAgICA8aW9uLWJ1dHRvbiBzaXplPVwic21hbGxcIiBmaWxsPVwiY2xlYXJcIiB0aXRsZT1cInt7J0Bjby5tbW9ucy9pb25pYy1leHRlbnNpb25zL2h0bWwtZWRpdG9yI1JlZG8nIHwgaW50bE1lc3NhZ2V9fVwiIFtkaXNhYmxlZF09XCIhY2FuUmVkb1wiIChjbGljayk9XCJyZWRvKClcIj5cbiAgICAgICAgICAgICAgICA8aW9uLWljb24gbmFtZT1cImFzc2V0cy9odG1sLWVkaXRvci9yZWRvLnN2Z1wiIHNsb3Q9XCJpY29uLW9ubHlcIj48L2lvbi1pY29uPlxuICAgICAgICAgICAgPC9pb24tYnV0dG9uPlxuICAgICAgICA8L2Rpdj5cbiAgICBgLFxuICAgIHN0eWxlczogW2BcbiAgICAgICAgOmhvc3QgeyBvdXRsaW5lOiBub25lOyBkaXNwbGF5OiBmbGV4OyBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsgZmxleC13cmFwOiB3cmFwOyBwb3NpdGlvbjogc3RpY2t5OyBwb3NpdGlvbjogLXdlYmtpdC1zdGlja3k7IHRvcDogMHB4OyBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1iYWNrZ3JvdW5kKTsgei1pbmRleDogMTsgfVxuICAgICAgICA6aG9zdC1jb250ZXh0KC5pb24tZm9jdXNlZCkgeyBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1iYWNrZ3JvdW5kLWZvY3VzZWQpOyB9XG4gICAgICAgIDpob3N0IGlvbi1idXR0b24geyBtYXJnaW46IDBweCA0cHg7IC0tcGFkZGluZy1lbmQ6IDJweDsgLS1wYWRkaW5nLXN0YXJ0OiA0cHg7IH1cbiAgICAgICAgOmhvc3QgaW9uLWJ1dHRvbi5hY3RpdmUtZmVhdHVyZSBzcGFuIHsgZm9udC13ZWlnaHQ6IDgwMDsgfVxuICAgICAgICA6aG9zdCBpb24taWNvbltzbG90PVwiZW5kXCJdIHsgbWFyZ2luOiAwcHg7IH1cbiAgICAgICAgOmhvc3QgaW9uLWJ1dHRvbltkaXNhYmxlZF0geyBvcGFjaXR5OiAwLjU7IH1cbiAgICAgICAgOmhvc3QgW2lvbngtLWJ1dHRvbnMtZ3JvdXBdIHsgZGlzcGxheTogZmxleDsgfVxuICAgICAgICA6aG9zdCBbaW9ueC0tYnV0dG9ucy1ncm91cF0gaW9uLWJ1dHRvbjpub3QoOmxhc3QtY2hpbGQpIHsgbWFyZ2luLXJpZ2h0OiAwcHg7IH1cbiAgICBgXVxufSlcbmV4cG9ydCBjbGFzcyBUb29sYmFyIGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgcG9wb3ZlckNvbnRyb2xsZXI6IFBvcG92ZXJDb250cm9sbGVyLFxuICAgICAgICBwcml2YXRlIHBsYXRmb3JtOiBQbGF0Zm9ybSxcbiAgICAgICAgcHVibGljIHJlYWRvbmx5IGVkaXRvcjogSHRtbEVkaXRvcixcbiAgICAgICAgcHJvdGVjdGVkIGV2ZW50TWFuYWdlcjogRXZlbnRNYW5hZ2VyLFxuICAgICAgICBwcml2YXRlIG1vZGFsQ29udHJvbGxlcjogTW9kYWxDb250cm9sbGVyXG4gICAgKSB7XG5cbiAgICB9XG5cbiAgICBhc3luYyBzaG93TWVudShldmVudDogRXZlbnQsIG1lbnU6IHN0cmluZykge1xuXG4gICAgICAgIGNvbnN0IGNvbXBvbmVudHMgPSB7XG4gICAgICAgICAgICB0ZXh0OiBUZXh0Rm9ybWF0TWVudSxcbiAgICAgICAgICAgIGxpc3Q6IExpc3RNZW51LFxuICAgICAgICAgICAgYWxpZ25tZW50OiBBbGlnbm1lbnRNZW51LFxuICAgICAgICAgICAgaW5zZXJ0OiBJbnNlcnRNZW51LFxuICAgICAgICAgICAgaGVhZGluZzogSGVhZGluZ01lbnVcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBwb3BvdmVyID0gYXdhaXQgdGhpcy5wb3BvdmVyQ29udHJvbGxlci5jcmVhdGUoe1xuICAgICAgICAgICAgY29tcG9uZW50OiBjb21wb25lbnRzW21lbnVdLFxuICAgICAgICAgICAgY29tcG9uZW50UHJvcHM6IHtcbiAgICAgICAgICAgICAgICBlZGl0b3I6IHRoaXMuZWRpdG9yXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZXZlbnQ6IGV2ZW50LFxuICAgICAgICAgICAgc2hvd0JhY2tkcm9wOiB0aGlzLnBsYXRmb3JtLmlzKFwiaW9zXCIpXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHBvcG92ZXIucHJlc2VudCgpO1xuICAgIH1cblxuICAgIGFjdGl2ZUZlYXR1cmVzOiB7XG4gICAgICAgIGxpbms/OiBib29sZWFuLFxuICAgICAgICB0ZXh0PzogYm9vbGVhbixcbiAgICAgICAgYWxpZ25tZW50PzogYm9vbGVhbixcbiAgICAgICAgaGVhZGluZz86IGJvb2xlYW47XG4gICAgICAgIGxpc3Q/OiBib29sZWFuXG4gICAgfSA9IHt9O1xuXG4gICAgYXN5bmMgZWRpdExpbmsoKSB7XG4gICAgICAgIExpbmtNb2RhbC5wcmVzZW50KHRoaXMubW9kYWxDb250cm9sbGVyLCB0aGlzLmVkaXRvcik7XG4gICAgfVxuXG4gICAgY2FuVW5kbzogYm9vbGVhbjtcblxuICAgIGNhblJlZG86IGJvb2xlYW47XG5cbiAgICB1bmRvKCkge1xuICAgICAgICB1bmRvKHRoaXMuZWRpdG9yLnZpZXcuc3RhdGUsICh0cmFuc2FjdGlvbikgPT4gdGhpcy5lZGl0b3Iudmlldy51cGRhdGVTdGF0ZSh0aGlzLmVkaXRvci52aWV3LnN0YXRlLmFwcGx5KHRyYW5zYWN0aW9uKSkpO1xuICAgICAgICB0aGlzLmVkaXRvci5mb2N1cygpO1xuICAgIH1cblxuICAgIHJlZG8oKSB7XG4gICAgICAgIHJlZG8odGhpcy5lZGl0b3Iudmlldy5zdGF0ZSwgKHRyYW5zYWN0aW9uKSA9PiB0aGlzLmVkaXRvci52aWV3LnVwZGF0ZVN0YXRlKHRoaXMuZWRpdG9yLnZpZXcuc3RhdGUuYXBwbHkodHJhbnNhY3Rpb24pKSk7XG4gICAgICAgIHRoaXMuZWRpdG9yLmZvY3VzKCk7XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIGVkaXRvclNlbGVjdGlvbkNoYW5nZWQoKSB7XG5cbiAgICAgICAgdGhpcy5jYW5VbmRvID0gdW5kb0RlcHRoKHRoaXMuZWRpdG9yLnZpZXcuc3RhdGUpID4gMDtcbiAgICAgICAgdGhpcy5jYW5SZWRvID0gcmVkb0RlcHRoKHRoaXMuZWRpdG9yLnZpZXcuc3RhdGUpID4gMDtcblxuICAgICAgICB0aGlzLmFjdGl2ZUZlYXR1cmVzID0ge307XG5cbiAgICAgICAgdGhpcy5hY3RpdmVGZWF0dXJlcy50ZXh0ID0gYW55TWFya0FjdGl2ZSh0aGlzLmVkaXRvci52aWV3LnN0YXRlLCBbc2NoZW1hLm1hcmtzLnN0cm9uZywgc2NoZW1hLm1hcmtzLmVtLCBzY2hlbWEubWFya3MudW5kZXJsaW5lLCBzY2hlbWEubWFya3MuZm9udFNpemVdKTtcbiAgICAgICAgdGhpcy5hY3RpdmVGZWF0dXJlcy5saXN0ID0gISFmaW5kUGFyZW50Tm9kZShwcmVkaWNhdGUgPT4gcHJlZGljYXRlLmhhc01hcmt1cChzY2hlbWEubm9kZXMub3JkZXJlZExpc3QpIHx8IHByZWRpY2F0ZS5oYXNNYXJrdXAoc2NoZW1hLm5vZGVzLmJ1bGxldExpc3QpKSh0aGlzLmVkaXRvci5zdGF0ZS5zZWxlY3Rpb24pO1xuICAgICAgICB0aGlzLmFjdGl2ZUZlYXR1cmVzLmFsaWdubWVudCA9IGlzQmxvY2tNYXJrQWN0aXZlKHRoaXMuZWRpdG9yLnZpZXcuc3RhdGUsIHNjaGVtYS5tYXJrcy5hbGlnbm1lbnQpO1xuICAgICAgICB0aGlzLmFjdGl2ZUZlYXR1cmVzLmhlYWRpbmcgPSAhIWZpbmRQYXJlbnROb2RlT2ZUeXBlKHNjaGVtYS5ub2Rlcy5oZWFkaW5nKSh0aGlzLmVkaXRvci5zdGF0ZS5zZWxlY3Rpb24pO1xuICAgICAgICB0aGlzLmFjdGl2ZUZlYXR1cmVzLmxpbmsgPSBpc01hcmtBY3RpdmUodGhpcy5lZGl0b3Iudmlldy5zdGF0ZSwgc2NoZW1hLm1hcmtzLmxpbmspO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2VsZWN0aW9uU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG5cbiAgICBhc3luYyBuZ09uSW5pdCgpIHtcblxuICAgICAgICB0aGlzLnNlbGVjdGlvblN1YnNjcmlwdGlvbiA9IHRoaXMuZWRpdG9yLnNlbGVjdGlvbkNoYW5nZS5zdWJzY3JpYmUoKCkgPT4gdGhpcy5lZGl0b3JTZWxlY3Rpb25DaGFuZ2VkKCkpO1xuXG4gICAgICAgIHRoaXMuZWRpdG9yU2VsZWN0aW9uQ2hhbmdlZCgpO1xuICAgIH1cblxuICAgIG5nT25EZXN0cm95KCkge1xuICAgICAgICB1bnN1YnNjcmliZSh0aGlzLnNlbGVjdGlvblN1YnNjcmlwdGlvbik7XG4gICAgfVxuXG59XG4iXX0=